# Transly 基于角色的访问控制 (RBAC) 策略

## 1. 概述

本文件定义了 Transly 平台中的用户角色及其相应的权限。基于角色的访问控制 (RBAC) 是我们安全模型的核心，旨在确保用户只能访问其被授权的资源和功能。

## 2. 角色定义

我们在系统中定义了三种主要角色。这些角色通过 `public.users` 表中的 `role` 列进行管理。

- **`admin` (管理员)**
  - **描述**: 拥有系统最高权限，负责系统管理、用户管理和内容审核。
  - **分配**: 由系统所有者通过数据库手动分配。

- **`pro_user` (付费用户)**
  - **描述**: 已订阅付费服务的用户，享有更高的使用限额和高级功能。
  - **分配**: 用户成功完成积分购买或订阅后，通过系统自动升级。当订阅到期或退款后，角色会自动降级为 `free_user`。

- **`free_user` (免费用户)**
  - **描述**: 默认角色，适用于所有新注册用户。可以使用核心功能，但有一定的使用限制。
  - **分配**: 用户注册后的默认角色。

## 3. 权限矩阵

下表详细列出了每个角色对各项功能的访问权限。

| 功能/资源                     | `guest` (游客) | `free_user` (免费用户) | `pro_user` (付费用户) | `admin` (管理员) | 备注                                            |
| ----------------------------- | :------------: | :------------------: | :-----------------: | :--------------: | ----------------------------------------------- |
| **通用功能**                  |                |                      |                     |                  |                                                 |
| 查看网站公开页面              |       ✅       |          ✅          |         ✅          |        ✅        | 如主页、关于我们、价格页                        |
| 注册/登录                     |       ✅       |          ✅          |         ✅          |        ✅        |                                                 |
| **核心翻译功能**              |                |                      |                     |                  |                                                 |
| 文本翻译                      |       ✅       |          ✅          |         ✅          |        ✅        | 游客有每日免费额度，超出后需登录                |
| - 字符数限制/次               |      500       |         1,000        |       10,000        |     无限制     |                                                 |
| - 每日调用次数                |       10       |          50          |       无限制        |     无限制     |                                                 |
| 文档翻译                      |       ❌       |          ✅          |         ✅          |        ✅        |                                                 |
| - 文件大小限制                |       -        |         1 MB         |        50 MB        |     无限制     |                                                 |
| - 每日上传次数                |       -        |          3           |         50          |     无限制     |                                                 |
| - 支持的文件格式              |       -        |      `.txt`, `.docx`     |  `.pdf`, `.pptx` 等  |      所有      | 付费用户支持更多格式                          |
| **用户数据管理**              |                |                      |                     |                  |                                                 |
| 查看个人资料                  |       ❌       |          ✅          |         ✅          |        ✅        |                                                 |
| 修改个人资料                  |       ❌       |          ✅          |         ✅          |        ✅        | 管理员可以修改所有用户的资料                    |
| 查看个人积分和交易记录        |       ❌       |          ✅          |         ✅          |        ✅        | 管理员可以查看所有用户的记录                    |
| **支付与积分**                |                |                      |                     |                  |                                                 |
| 购买积分                      |       ❌       |          ✅          |         ✅          |        ✅        |                                                 |
| 查看支付历史                  |       ❌       |          ✅          |         ✅          |        ✅        |                                                 |
| 申请退款                      |       ❌       |          ✅          |         ✅          |      (N/A)       |                                                 |
| **管理功能**                  |                |                      |                     |                  |                                                 |
| 访问管理后台                  |       ❌       |          ❌          |         ❌          |        ✅        |                                                 |
| 查看所有用户列表              |       ❌       |          ❌          |         ❌          |        ✅        |                                                 |
| 修改用户角色/积分             |       ❌       |          ❌          |         ❌          |        ✅        |                                                 |
| 查看系统统计数据              |       ❌       |          ❌          |         ❌          |        ✅        |                                                 |
| 管理支付/退款                 |       ❌       |          ❌          |         ❌          |        ✅        |                                                 |

**符号说明**:
- ✅: 允许
- ❌: 不允许
- (N/A): 不适用

## 4. RLS (行级安全) 策略集成

上述权限将通过数据库的行级安全 (RLS) 策略来强制执行。

- **基本原则**:
    - 用户只能 `SELECT`, `UPDATE`, `DELETE` 自己的数据（例如 `user_profiles`, `credit_transactions`）。
    - 管理员角色 (`admin`) 可以通过 RLS 策略绕过这些限制，以执行管理任务。
    - 角色信息将从经过身份验证的用户的 JWT 中提取，或通过 `get_user_role()` 函数在数据库层面进行检查。

- **示例策略**:
  ```sql
  -- 只允许管理员删除用户（示例）
  CREATE POLICY "Admins can delete users" ON public.users FOR DELETE
  USING (get_user_role(auth.uid()) = 'admin');
  ```

## 5. 实现说明

- **前端**: UI 将根据用户的角色动态显示或隐藏功能入口。
- **后端 (API)**: API 路由将通过中间件或在处理函数开始时检查用户角色和权限。
- **数据库**: RLS 策略作为最后一道防线，确保即使前端或后端逻辑被绕过，数据访问仍然是安全的。

---
**最后更新:** 2025-01-25
**版本:** 1.0
**负责人:** 开发团队 