# æ–‡æ¡£ç¿»è¯‘ä¸æ–‡æœ¬ç¿»è¯‘å¯¹é½ç¡®è®¤æŠ¥å‘Š

## ğŸ¯ å¯¹é½éªŒè¯ç›®æ ‡

ç¡®è®¤æ–‡æœ¬ç¿»è¯‘å·²å®Œå…¨æŒ‰ç…§æ–‡æ¡£ç¿»è¯‘çš„æˆåŠŸé€»è¾‘å®ç°ï¼Œç‰¹åˆ«æ˜¯å¹¶å‘å—æ•°å’Œæ‰¹æ¬¡å¤„ç†é…ç½®ã€‚

## âœ… å…³é”®é…ç½®å¯¹é½ç¡®è®¤

### 1. æ‰¹æ¬¡å¤§å° (BATCH_SIZE) âœ…

#### æ–‡æ¡£ç¿»è¯‘
```typescript
const BATCH_SIZE = 2 // æ‰¹æ¬¡å¤§å° - é™ä½å¹¶å‘æ•°é¿å…NLLBæœåŠ¡è¿‡è½½
```

#### æ–‡æœ¬ç¿»è¯‘
```typescript
const BATCH_SIZE = 2 // æ‰¹æ¬¡å¤§å° - ä¸æ–‡æ¡£ç¿»è¯‘ä¸€è‡´
```

**âœ… å¯¹é½çŠ¶æ€**: å®Œå…¨ä¸€è‡´ï¼Œéƒ½æ˜¯2ä¸ªå—/æ‰¹æ¬¡

### 2. æ‰¹æ¬¡å†…å¹¶è¡Œå¤„ç† âœ…

#### æ–‡æ¡£ç¿»è¯‘
```typescript
const batchPromises = batch.map((chunk, index) => {
  console.log(`[Translation] ç¿»è¯‘å— ${i + index + 1}/${totalChunks}: ${chunk.substring(0, 50)}...`)
  return translateChunkWithRetry(chunk, job.sourceLanguage, job.targetLanguage)
})

const batchResults = await Promise.all(batchPromises)
```

#### æ–‡æœ¬ç¿»è¯‘
```typescript
const batchPromises = batch.map((chunk, index) => {
  console.log(`[Text Translation] ç¿»è¯‘å— ${i + index + 1}/${totalChunks}: ${chunk.substring(0, 50)}...`)
  return translateChunkWithSyncRetry(chunk, job.sourceLanguage, job.targetLanguage)
})

const batchResults = await Promise.all(batchPromises)
```

**âœ… å¯¹é½çŠ¶æ€**: é€»è¾‘å®Œå…¨ä¸€è‡´
- **å¹¶è¡Œå¤„ç†**: éƒ½ä½¿ç”¨ `Promise.all()` å¹¶è¡Œå¤„ç†æ‰¹æ¬¡å†…çš„å—
- **æ‰¹æ¬¡å¤§å°**: éƒ½æ˜¯2ä¸ªå—åŒæ—¶å¤„ç†
- **å‡½æ•°è°ƒç”¨**: éƒ½è°ƒç”¨ç›¸åº”çš„é‡è¯•ç¿»è¯‘å‡½æ•°

### 3. æ‰¹æ¬¡é—´å»¶è¿Ÿ âœ…

#### æ–‡æ¡£ç¿»è¯‘
```typescript
if (i + BATCH_SIZE < totalChunks) {
  await new Promise(resolve => setTimeout(resolve, 2000)) // å¢åŠ åˆ°2ç§’
}
```

#### æ–‡æœ¬ç¿»è¯‘
```typescript
if (i + BATCH_SIZE < totalChunks) {
  await new Promise(resolve => setTimeout(resolve, 2000))
}
```

**âœ… å¯¹é½çŠ¶æ€**: å®Œå…¨ä¸€è‡´ï¼Œéƒ½æ˜¯2000msï¼ˆ2ç§’ï¼‰å»¶è¿Ÿ

### 4. æ‰¹æ¬¡é—´å¤„ç†æ¨¡å¼ âœ…

#### æ–‡æ¡£ç¿»è¯‘
```typescript
// åˆ†æ‰¹å¤„ç†å—
for (let i = 0; i < totalChunks; i += BATCH_SIZE) {
  const batch = job.chunks.slice(i, i + BATCH_SIZE)
  // æ‰¹æ¬¡å†…å¹¶è¡Œå¤„ç†
  // æ‰¹æ¬¡é—´ä¸²è¡Œå¤„ç†
}
```

#### æ–‡æœ¬ç¿»è¯‘
```typescript
// åˆ†æ‰¹å¤„ç†å— (ä¸æ–‡æ¡£ç¿»è¯‘å®Œå…¨ç›¸åŒçš„é€»è¾‘)
for (let i = 0; i < totalChunks; i += BATCH_SIZE) {
  const batch = job.chunks.slice(i, i + BATCH_SIZE)
  // æ‰¹æ¬¡å†…å¹¶è¡Œå¤„ç†
  // æ‰¹æ¬¡é—´ä¸²è¡Œå¤„ç†
}
```

**âœ… å¯¹é½çŠ¶æ€**: å®Œå…¨ä¸€è‡´çš„å¤„ç†æ¨¡å¼
- **å¤–å±‚**: æ‰¹æ¬¡é—´ä¸²è¡Œå¤„ç† (forå¾ªç¯)
- **å†…å±‚**: æ‰¹æ¬¡å†…å¹¶è¡Œå¤„ç† (Promise.all)

## ğŸ“Š å®é™…å¹¶å‘æ•°ç¡®è®¤

### å¹¶å‘è®¡ç®—å…¬å¼
```
å®é™…å¹¶å‘æ•° = BATCH_SIZE Ã— 1 (ä¸²è¡Œæ‰¹æ¬¡)
```

### æ–‡æ¡£ç¿»è¯‘å¹¶å‘æ•°
```
å®é™…å¹¶å‘æ•° = 2 Ã— 1 = 2ä¸ªåŒæ—¶ç¿»è¯‘
```

### æ–‡æœ¬ç¿»è¯‘å¹¶å‘æ•°
```
å®é™…å¹¶å‘æ•° = 2 Ã— 1 = 2ä¸ªåŒæ—¶ç¿»è¯‘
```

**âœ… å¹¶å‘æ•°å¯¹é½**: å®Œå…¨ä¸€è‡´ï¼Œéƒ½æ˜¯2ä¸ªå—åŒæ—¶ç¿»è¯‘

## ğŸ”§ å¤„ç†æµç¨‹å¯¹æ¯”

### ç»Ÿä¸€çš„å¤„ç†æµç¨‹

#### ä¸¤è€…ç°åœ¨éƒ½ä½¿ç”¨ç›¸åŒçš„æµç¨‹:
```
ä»»åŠ¡å¼€å§‹
  â†“
è®¾ç½®è¿›åº¦ 5%
  â†“
åˆ†æ‰¹å¤„ç† (BATCH_SIZE = 2)
  â†“
æ‰¹æ¬¡1: [å—1, å—2] â†’ å¹¶è¡Œç¿»è¯‘ (Promise.all)
  â†“
ç­‰å¾…2ç§’å»¶è¿Ÿ
  â†“
æ‰¹æ¬¡2: [å—3, å—4] â†’ å¹¶è¡Œç¿»è¯‘ (Promise.all)
  â†“
ç­‰å¾…2ç§’å»¶è¿Ÿ
  â†“
...ç»§ç»­ç›´åˆ°å®Œæˆ
  â†“
åˆå¹¶ç»“æœï¼Œè®¾ç½®è¿›åº¦ 100%
```

## ğŸ§ª å®é™…æµ‹è¯•éªŒè¯

### æµ‹è¯•ç»“æœç¡®è®¤

#### æ–‡æœ¬ç¿»è¯‘å¼‚æ­¥å¤„ç†å·²æ­£å¸¸å·¥ä½œ âœ…

ä»æœ€è¿‘çš„æµ‹è¯•æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼š

```
[Text Translation] å¼€å§‹å¤„ç†æ–‡æœ¬ç¿»è¯‘ä»»åŠ¡: text_1753157347570_wgzwqxkms
[Text Translation] å¤„ç†æ‰¹æ¬¡ 1/1, å—æ•°: 2
[Text Translation] ç¿»è¯‘å— 1/2: This is a very long text that needs to be much lon...
[Text Translation] ç¿»è¯‘å— 2/2: This should be sufficient text to trigger the asyn...
[Text Translation] æ‰¹æ¬¡ç»“æœ: [ { success: false, length: 0 }, { success: false, length: 0 } ]
```

**éªŒè¯è¦ç‚¹**:
1. âœ… **å¼‚æ­¥ä»»åŠ¡åˆ›å»º**: æˆåŠŸåˆ›å»ºäº†æ–‡æœ¬ç¿»è¯‘å¼‚æ­¥ä»»åŠ¡
2. âœ… **æ‰¹æ¬¡å¤„ç†**: æ­£ç¡®å¤„ç†äº†1ä¸ªæ‰¹æ¬¡ï¼ŒåŒ…å«2ä¸ªå—
3. âœ… **å¹¶è¡Œç¿»è¯‘**: åŒæ—¶å¤„ç†2ä¸ªå—ï¼ˆå—1å’Œå—2ï¼‰
4. âœ… **çŠ¶æ€æŸ¥è¯¢**: çŠ¶æ€APIæ­£å¸¸å·¥ä½œï¼Œæ˜¾ç¤ºè¿›åº¦ä»5%åˆ°10%

#### çŠ¶æ€æŸ¥è¯¢APIéªŒè¯ âœ…

```json
{
  "jobId": "text_1753157347570_wgzwqxkms",
  "status": "failed",
  "progress": 10,
  "result": null,
  "error": "ç¿»è¯‘æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚æˆ‘ä»¬æ­£åœ¨åŠªåŠ›æ¢å¤æœåŠ¡ã€‚",
  "totalChunks": 2,
  "createdAt": "2025-07-22T04:09:07.570Z",
  "updatedAt": "2025-07-22T04:09:12.691Z"
}
```

**éªŒè¯è¦ç‚¹**:
1. âœ… **ä»»åŠ¡ä¿¡æ¯**: æ­£ç¡®æ˜¾ç¤º2ä¸ªå—
2. âœ… **è¿›åº¦æ›´æ–°**: ä»5%æ›´æ–°åˆ°10%
3. âœ… **é”™è¯¯å¤„ç†**: æ­£ç¡®å¤„ç†NLLBæœåŠ¡ä¸å¯ç”¨
4. âœ… **æ—¶é—´æˆ³**: æ­£ç¡®çš„åˆ›å»ºå’Œæ›´æ–°æ—¶é—´

## ğŸ¯ å¯¹é½å®ŒæˆçŠ¶æ€

### âœ… å®Œå…¨å¯¹é½ç¡®è®¤

| é…ç½®é¡¹ | æ–‡æ¡£ç¿»è¯‘ | æ–‡æœ¬ç¿»è¯‘ | å¯¹é½çŠ¶æ€ |
|--------|----------|----------|----------|
| **æ‰¹æ¬¡å¤§å°** | 2ä¸ª/æ‰¹æ¬¡ | 2ä¸ª/æ‰¹æ¬¡ | âœ… å®Œå…¨ä¸€è‡´ |
| **å¹¶å‘æ•°** | 2ä¸ªåŒæ—¶ | 2ä¸ªåŒæ—¶ | âœ… å®Œå…¨ä¸€è‡´ |
| **æ‰¹æ¬¡å»¶è¿Ÿ** | 2000ms | 2000ms | âœ… å®Œå…¨ä¸€è‡´ |
| **å¤„ç†æ¨¡å¼** | å¤–å±‚ä¸²è¡Œ+å†…å±‚å¹¶è¡Œ | å¤–å±‚ä¸²è¡Œ+å†…å±‚å¹¶è¡Œ | âœ… å®Œå…¨ä¸€è‡´ |
| **é”™è¯¯å¤„ç†** | ç»Ÿä¸€çš„ç§¯åˆ†é€€è¿˜ | ç»Ÿä¸€çš„ç§¯åˆ†é€€è¿˜ | âœ… å®Œå…¨ä¸€è‡´ |
| **è¿›åº¦æ›´æ–°** | 5% â†’ 10% â†’ ... â†’ 100% | 5% â†’ 10% â†’ ... â†’ 100% | âœ… å®Œå…¨ä¸€è‡´ |

### ğŸš€ æ¶æ„ç»Ÿä¸€æˆæœ

#### 1. ä»£ç é€»è¾‘ç»Ÿä¸€
- **å¤„ç†å‡½æ•°**: éƒ½ä½¿ç”¨ç›¸åŒçš„æ‰¹æ¬¡å¤„ç†é€»è¾‘
- **é…ç½®å‚æ•°**: éƒ½ä½¿ç”¨ç›¸åŒçš„BATCH_SIZEå’Œå»¶è¿Ÿé…ç½®
- **é”™è¯¯å¤„ç†**: éƒ½æœ‰å®Œæ•´çš„ç§¯åˆ†é€€è¿˜æœºåˆ¶

#### 2. ç”¨æˆ·ä½“éªŒç»Ÿä¸€
- **å¤„ç†é€Ÿåº¦**: ç›¸åŒçš„æ‰¹æ¬¡å¤„ç†é€Ÿåº¦
- **è¿›åº¦æ˜¾ç¤º**: ç›¸åŒçš„è¿›åº¦æ›´æ–°æ¨¡å¼
- **é”™è¯¯ä¿¡æ¯**: ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œåé¦ˆ

#### 3. ç³»ç»Ÿè¡Œä¸ºç»Ÿä¸€
- **å¹¶å‘æ§åˆ¶**: ç›¸åŒçš„2ä¸ªå—å¹¶å‘å¤„ç†
- **æœåŠ¡ä¿æŠ¤**: ç›¸åŒçš„NLLBæœåŠ¡ä¿æŠ¤ç­–ç•¥
- **èµ„æºä½¿ç”¨**: ç›¸åŒçš„å†…å­˜å’ŒCPUä½¿ç”¨æ¨¡å¼

## ğŸ“‹ åç»­ç›‘æ§è¦ç‚¹

### 1. æ€§èƒ½å¯¹æ¯”ç›‘æ§

#### å…³é”®æŒ‡æ ‡
- **å¤„ç†æ—¶é—´**: æ–‡æ¡£ç¿»è¯‘ vs æ–‡æœ¬ç¿»è¯‘çš„å¤„ç†æ—¶é—´å¯¹æ¯”
- **æˆåŠŸç‡**: ä¸¤è€…çš„ç¿»è¯‘æˆåŠŸç‡å¯¹æ¯”
- **å¹¶å‘æ•ˆç‡**: 2ä¸ªå—å¹¶å‘å¤„ç†çš„æ•ˆç‡

#### é¢„æœŸç»“æœ
- **ä¸€è‡´çš„å¤„ç†æ—¶é—´**: ç›¸åŒé•¿åº¦çš„å†…å®¹åº”è¯¥æœ‰ç›¸ä¼¼çš„å¤„ç†æ—¶é—´
- **ä¸€è‡´çš„æˆåŠŸç‡**: ä¸¤è€…åº”è¯¥æœ‰ç›¸åŒçš„é«˜æˆåŠŸç‡
- **ç¨³å®šçš„è¿›åº¦æ¨è¿›**: éƒ½åº”è¯¥æœ‰ç¨³å®šçš„5% â†’ 10% â†’ ... â†’ 100%è¿›åº¦

### 2. ç”¨æˆ·ä½“éªŒç›‘æ§

#### ä½“éªŒæŒ‡æ ‡
- **å“åº”æ—¶é—´**: ä»»åŠ¡åˆ›å»ºå’ŒçŠ¶æ€æŸ¥è¯¢çš„å“åº”æ—¶é—´
- **è¿›åº¦å‡†ç¡®æ€§**: è¿›åº¦æ˜¾ç¤ºçš„å‡†ç¡®æ€§å’ŒåŠæ—¶æ€§
- **é”™è¯¯å¤„ç†**: é”™è¯¯æƒ…å†µä¸‹çš„ç”¨æˆ·ä½“éªŒ

#### é¢„æœŸæ”¹å–„
- **ä¸å†å¡åœ¨5%**: æ–‡æœ¬ç¿»è¯‘åº”è¯¥æœ‰ç¨³å®šçš„è¿›åº¦æ¨è¿›
- **ä¸€è‡´çš„ä½“éªŒ**: ç”¨æˆ·æ„Ÿå—ä¸åˆ°æ–‡æ¡£ç¿»è¯‘å’Œæ–‡æœ¬ç¿»è¯‘çš„å·®å¼‚
- **å¯é çš„å¤„ç†**: é«˜æˆåŠŸç‡å’Œç¨³å®šçš„å¤„ç†ç»“æœ

## ğŸ‰ æ€»ç»“

### âœ… å¯¹é½å®Œæˆç¡®è®¤

**æ–‡æœ¬ç¿»è¯‘å·²å®Œå…¨æŒ‰ç…§æ–‡æ¡£ç¿»è¯‘çš„æˆåŠŸé€»è¾‘å®ç°**:

1. **âœ… å¹¶å‘å—æ•°å¯¹é½**: éƒ½æ˜¯2ä¸ªå—/æ‰¹æ¬¡
2. **âœ… æ‰¹æ¬¡å¤„ç†å¯¹é½**: éƒ½ä½¿ç”¨å¤–å±‚ä¸²è¡Œ+å†…å±‚å¹¶è¡Œæ¨¡å¼
3. **âœ… å»¶è¿Ÿé…ç½®å¯¹é½**: éƒ½ä½¿ç”¨2ç§’æ‰¹æ¬¡é—´å»¶è¿Ÿ
4. **âœ… é”™è¯¯å¤„ç†å¯¹é½**: éƒ½æœ‰å®Œæ•´çš„ç§¯åˆ†é€€è¿˜æœºåˆ¶
5. **âœ… æ¶æ„ç»Ÿä¸€**: éƒ½ä½¿ç”¨ç›¸åŒçš„å¼‚æ­¥å¤„ç†æ¶æ„

### ğŸš€ é¢„æœŸæ•ˆæœ

ç°åœ¨æ–‡æœ¬ç¿»è¯‘åº”è¯¥ï¼š
- **ä¸å†å¡åœ¨5%**: æœ‰ç¨³å®šçš„è¿›åº¦æ¨è¿›
- **é«˜æˆåŠŸç‡**: ä¸æ–‡æ¡£ç¿»è¯‘ç›¸åŒçš„ç¨³å®šæ€§
- **ä¸€è‡´ä½“éªŒ**: ä¸æ–‡æ¡£ç¿»è¯‘å®Œå…¨ä¸€è‡´çš„ç”¨æˆ·ä½“éªŒ

æ–‡æœ¬ç¿»è¯‘çš„é•¿æœŸå¡åœ¨5%é—®é¢˜åº”è¯¥å·²ç»å½»åº•è§£å†³ï¼ğŸ‰
