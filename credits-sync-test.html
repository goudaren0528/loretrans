<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§¯åˆ†åŒæ­¥æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ç§¯åˆ†åŒæ­¥æµ‹è¯•é¡µé¢</h1>
    
    <div class="test-section info">
        <h3>æµ‹è¯•è¯´æ˜</h3>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•ç§¯åˆ†æ˜¾ç¤ºåŒæ­¥é—®é¢˜çš„ä¿®å¤æ•ˆæœã€‚</p>
        <p>è¯·åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„æ§åˆ¶å°ä¸­æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚</p>
    </div>
    
    <div class="test-section">
        <h3>å½“å‰çŠ¶æ€</h3>
        <div id="status">æ­£åœ¨æ£€æŸ¥...</div>
    </div>
    
    <div class="test-section">
        <h3>æµ‹è¯•æ“ä½œ</h3>
        <button onclick="testCreditsSync()">æµ‹è¯•ç§¯åˆ†åŒæ­¥</button>
        <button onclick="simulateUpload()">æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ </button>
        <button onclick="checkDebugInfo()">æ£€æŸ¥è°ƒè¯•ä¿¡æ¯</button>
        <button onclick="clearConsole()">æ¸…ç©ºæ§åˆ¶å°</button>
    </div>
    
    <div class="test-section">
        <h3>æµ‹è¯•ç»“æœ</h3>
        <div id="results">ç­‰å¾…æµ‹è¯•...</div>
    </div>
    
    <script>
        // æ¨¡æ‹Ÿç§¯åˆ†åŒæ­¥æµ‹è¯•
        function testCreditsSync() {
            console.log('ğŸ§ª å¼€å§‹ç§¯åˆ†åŒæ­¥æµ‹è¯•...')
            
            // æ¨¡æ‹Ÿ API è¿”å›ç§¯åˆ†æ•°æ®
            const mockApiResponse = {
                userId: '8d10fb8d-07de-49ba-8f04-158dbffa28c5',
                email: 'test01@test.com',
                credits: 5500
            }
            
            console.log('âœ… æ¨¡æ‹ŸAPIè¿”å›:', mockApiResponse)
            
            // æ£€æŸ¥å…¨å±€è°ƒè¯•çŠ¶æ€
            if (window.__CREDITS_DEBUG__) {
                console.log('ğŸ” å…¨å±€è°ƒè¯•çŠ¶æ€:', window.__CREDITS_DEBUG__)
            } else {
                console.log('âš ï¸  å…¨å±€è°ƒè¯•çŠ¶æ€æœªåˆå§‹åŒ–')
                window.__CREDITS_DEBUG__ = {
                    credits: mockApiResponse.credits,
                    isLoading: false,
                    lastUpdate: new Date().toISOString()
                }
            }
            
            updateResults('ç§¯åˆ†åŒæ­¥æµ‹è¯•å®Œæˆï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—')
        }
        
        // æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ 
        function simulateUpload() {
            console.log('ğŸ“ æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ ...')
            console.log('[Document Upload] å¼€å§‹è·å–è®¤è¯token')
            console.log('[Document Upload] ä¼šè¯æ£€æŸ¥ç»“æœ: æˆåŠŸ')
            console.log('[Document Upload] å‡†å¤‡å‘é€è¯·æ±‚')
            console.log('[Document Translator] File uploaded, refreshing credits')
            console.log('[useCredits] Fetching credits for user: 8d10fb8d-07de-49ba-8f04-158dbffa28c5')
            console.log('[useCredits] æŸ¥è¯¢åˆ°ç”¨æˆ·ç§¯åˆ†: 5500')
            
            updateResults('æ–‡ä»¶ä¸Šä¼ æ¨¡æ‹Ÿå®Œæˆï¼Œç§¯åˆ†åº”è¯¥å·²åˆ·æ–°')
        }
        
        // æ£€æŸ¥è°ƒè¯•ä¿¡æ¯
        function checkDebugInfo() {
            console.log('ğŸ” æ£€æŸ¥è°ƒè¯•ä¿¡æ¯...')
            
            const debugInfo = {
                globalDebug: window.__CREDITS_DEBUG__ || null,
                localStorage: {
                    hasAuthData: !!localStorage.getItem('supabase.auth.token'),
                    authDataLength: localStorage.getItem('supabase.auth.token')?.length || 0
                },
                userAgent: navigator.userAgent,
                timestamp: new Date().toISOString()
            }
            
            console.log('è°ƒè¯•ä¿¡æ¯:', debugInfo)
            updateResults('è°ƒè¯•ä¿¡æ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°')
        }
        
        // æ¸…ç©ºæ§åˆ¶å°
        function clearConsole() {
            console.clear()
            console.log('ğŸ§¹ æ§åˆ¶å°å·²æ¸…ç©º')
        }
        
        // æ›´æ–°ç»“æœæ˜¾ç¤º
        function updateResults(message) {
            const resultsDiv = document.getElementById('results')
            const timestamp = new Date().toLocaleTimeString()
            resultsDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus() {
            const statusDiv = document.getElementById('status')
            const hasDebug = !!window.__CREDITS_DEBUG__
            const debugCredits = window.__CREDITS_DEBUG__?.credits || 0
            
            statusDiv.innerHTML = `
                <div>è°ƒè¯•çŠ¶æ€: ${hasDebug ? 'âœ… å·²å¯ç”¨' : 'âŒ æœªå¯ç”¨'}</div>
                <div>è°ƒè¯•ç§¯åˆ†: ${debugCredits}</div>
                <div>æœ€åæ›´æ–°: ${window.__CREDITS_DEBUG__?.lastUpdate || 'æœªçŸ¥'}</div>
            `
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            console.log('ğŸš€ ç§¯åˆ†åŒæ­¥æµ‹è¯•é¡µé¢å·²åŠ è½½')
            updateStatus()
            
            // æ¯ç§’æ›´æ–°çŠ¶æ€
            setInterval(updateStatus, 1000)
        })
        
        // æ·»åŠ å…¨å±€è°ƒè¯•å‡½æ•°
        window.debugCredits = function() {
            console.log('=== ç§¯åˆ†è°ƒè¯•ä¿¡æ¯ ===')
            console.log('å…¨å±€è°ƒè¯•çŠ¶æ€:', window.__CREDITS_DEBUG__)
            
            // æ£€æŸ¥ localStorage ä¸­çš„ç”¨æˆ·ä¿¡æ¯
            const authData = localStorage.getItem('supabase.auth.token')
            if (authData) {
                try {
                    const parsed = JSON.parse(authData)
                    console.log('è®¤è¯çŠ¶æ€:', {
                        hasUser: !!parsed.user,
                        userId: parsed.user?.id,
                        email: parsed.user?.email
                    })
                } catch (e) {
                    console.log('è®¤è¯æ•°æ®è§£æå¤±è´¥:', e)
                }
            }
            
            console.log('è¯·æ£€æŸ¥ç½‘ç»œé¢æ¿ä¸­çš„ /api/auth/user è¯·æ±‚')
            console.log('è¯·æ£€æŸ¥ Supabase æ•°æ®åº“ä¸­çš„ users è¡¨')
        }
    </script>
</body>
</html>