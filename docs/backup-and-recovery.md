# Loretrans 数据备份与恢复策略

## 1. 概述

本文件旨在为 Loretrans 平台提供一个全面的数据备份与恢复指南。遵循本指南将有助于确保数据的持久性和业务的连续性，即使在发生意外数据丢失或系统故障时也能从容应对。

## 2. Supabase 自动备份

Supabase 为其托管的数据库提供强大的自动备份功能，即 **时间点恢复 (Point-in-Time Recovery, PITR)**。

### 2.1 功能说明

- **工作原理**: Supabase 持续归档数据库的预写日志 (WAL)，允许您将数据库恢复到过去特定时间点的状态（精确到秒）。
- **备份频率**: 备份是连续的，而不是每日快照。
- **数据保留期**:
    - **Pro Plan**: 默认保留7天，可根据需要延长至14天或28天。
    - **Free Plan**: 仅提供每日备份，保留期较短。
- **优点**:
    - 无需手动配置，开箱即用。
    - 恢复粒度高，可最大限度减少数据丢失。
    - 不会影响正在运行的数据库性能。

### 2.2 如何检查备份状态

1.  登录您的 [Supabase 账户](https://app.supabase.com/)。
2.  进入您的项目，导航到 **Database** -> **Backups**。
3.  在此页面，您可以看到：
    - 最早可恢复的时间点。
    - 最近的备份活动。
    - 可用的每日备份快照。

## 3. 手动备份

尽管 Supabase 提供了自动备份，但在进行重大数据库更改（如大型数据迁移）之前，进行一次手动备份是一个很好的习惯。

### 3.1 使用 `pg_dump`

`pg_dump` 是一个标准的 PostgreSQL 工具，用于创建数据库的逻辑备份。

**先决条件**:
- 安装 PostgreSQL 客户端工具。
- 获取您项目的数据库连接字符串 (在 Supabase Dashboard -> Project Settings -> Database 中找到)。

**备份命令**:

```bash
pg_dump "postgresql://postgres:[YOUR-PASSWORD]@[YOUR-HOST]:5432/postgres" > loretrans_backup_$(date +%Y%m%d).sql
```

**参数说明**:
- `[YOUR-PASSWORD]`: 替换为您的数据库密码。
- `[YOUR-HOST]`: 替换为您的项目主机地址。
- 该命令将整个数据库的 SQL 表示形式转储到一个 `.sql` 文件中。

**只备份数据**:
```bash
pg_dump "postgresql://postgres:[YOUR-PASSWORD]@[YOUR-HOST]:5432/postgres" --data-only --file=loretrans_data_backup.sql
```

**只备份结构 (Schema)**:
```bash
pg_dump "postgresql://postgres:[YOUR-PASSWORD]@[YOUR-HOST]:5432/postgres" --schema-only --file=loretrans_schema_backup.sql
```

## 4. 数据恢复流程

### 4.1 从 Supabase 自动备份中恢复

这是最推荐的恢复方式。

1.  访问 Supabase Dashboard -> **Database** -> **Backups**。
2.  在 **Point-in-Time Recovery** 部分，选择您希望恢复到的日期和时间。
3.  仔细阅读恢复操作的说明。**请注意：恢复操作会替换您当前的数据库。**
4.  确认操作后，Supabase 将开始恢复过程。恢复时间取决于数据库的大小。

### 4.2 从手动备份中恢复

当您需要恢复到一个新的、空的数据库，或者只想恢复特定数据时，此方法非常有用。

**恢复命令**:

```bash
psql "postgresql://postgres:[YOUR-PASSWORD]@[YOUR-HOST]:5432/postgres" < loretrans_backup_YYYYMMDD.sql
```

**重要提示**:
- 在执行恢复之前，强烈建议先清空目标数据库，以避免主键或唯一约束冲突。
- 恢复过程可能会因为版本不匹配或依赖关系而中断，需要仔细检查日志并解决问题。

## 5. 灾难恢复计划 (DRP)

制定一个清晰的灾难恢复计划至关重要。

### 5.1 联系人

- **主要负责人**: [填写姓名/团队]
- **备用联系人**: [填写姓名/团队]

### 5.2 恢复目标

- **恢复时间目标 (RTO)**: `2 小时` (系统应在2小时内恢复在线)。
- **恢复点目标 (RPO)**: `5 分钟` (最多可能丢失5分钟的数据)。

### 5.3 恢复步骤

1.  **评估情况**:
    - 确认问题的性质和范围（例如，是数据损坏、硬件故障还是服务中断）。
    - 立即在状态页或社交媒体上向用户发布通知。
2.  **决策**:
    - 根据评估结果，决定是使用 PITR 恢复还是手动恢复。通常 PITR 是首选。
3.  **执行恢复**:
    - 按照上文第4节的步骤执行恢复操作。
    - **在恢复期间，启用应用的维护模式**，向用户显示友好的提示信息。
4.  **验证**:
    - 恢复完成后，由技术团队进行全面验证，确保数据完整性和应用功能正常。
    - 随机抽查用户数据，确认其准确性。
5.  **恢复服务**:
    - 禁用维护模式，恢复对用户的服务。
    - 持续监控系统性能和日志，确保没有后续问题。
6.  **事后复盘 (Post-mortem)**:
    - 详细记录事件的起因、处理过程和结果。
    - 分析根本原因，并制定改进措施以防止未来再次发生。

---
**最后更新:** 2025-01-25
**版本:** 1.0
**负责人:** 开发团队 