# ğŸ”§ ç§¯åˆ†æ£€æŸ¥å’Œå¤šè¯­è¨€Keyä¿®å¤å®Œæˆ

**ä¿®å¤æ—¶é—´**: 2025-07-29  
**é—®é¢˜**: 1) å¤šè¯­è¨€keyé”™è¯¯å¯¼è‡´å¼¹çª—æ˜¾ç¤ºkeyè€Œéæ–‡æœ¬ 2) ç§¯åˆ†æ£€æŸ¥å¤±è´¥å¯¼è‡´æœ‰ç§¯åˆ†ç”¨æˆ·è¢«åˆ¤æ–­ä¸ºç§¯åˆ†ä¸è¶³  
**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ” é—®é¢˜åˆ†æ

### é—®é¢˜1: å¤šè¯­è¨€Keyé”™è¯¯
**é”™è¯¯ä¿¡æ¯**:
```
IntlError: MISSING_MESSAGE: Could not resolve `DocumentTranslator.DocumentTranslation.credits.insufficient_title` in messages for locale `en`.
IntlError: MISSING_MESSAGE: Could not resolve `DocumentTranslator.DocumentTranslation.credits.insufficient_description` in messages for locale `en`.
```

**æ ¹æœ¬åŸå› **: ç¿»è¯‘keyè·¯å¾„é”™è¯¯ï¼Œå®é™…çš„å¤šè¯­è¨€æ–‡ä»¶ä¸­æ²¡æœ‰è¿™äº›åµŒå¥—çš„keyè·¯å¾„ã€‚

### é—®é¢˜2: ç§¯åˆ†æ£€æŸ¥å¤±è´¥
**é”™è¯¯ä¿¡æ¯**:
```
è·å–ç”¨æˆ·ç§¯åˆ†å¤±è´¥: {
  code: 'PGRST202',
  message: 'Could not find the function public.validate_credit_balance(p_user_id) in the schema cache'
}
[FIFO Document Queue API] ç”¨æˆ·ç§¯åˆ†æ£€æŸ¥: éœ€è¦ 542, æ‹¥æœ‰ 0
```

**æ ¹æœ¬åŸå› **: ç§¯åˆ†æœåŠ¡è°ƒç”¨äº†ä¸å­˜åœ¨çš„æ•°æ®åº“å‡½æ•° `validate_credit_balance`ï¼Œå¯¼è‡´ç§¯åˆ†æŸ¥è¯¢å¤±è´¥ï¼Œè¿”å›0ç§¯åˆ†ã€‚

**ç”¨æˆ·å®é™…çŠ¶æ€**: 
- ç”¨æˆ·: hongwane322@gmail.com
- å‰ç«¯æ˜¾ç¤ºç§¯åˆ†: 34745
- åç«¯æŸ¥è¯¢ç§¯åˆ†: 0 (å› ä¸ºå‡½æ•°ä¸å­˜åœ¨)
- å®é™…éœ€è¦ç§¯åˆ†: 542

---

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤å¤šè¯­è¨€Keyé”™è¯¯

#### âœ… é—®é¢˜ä»£ç 
```typescript
toast({
  title: t('DocumentTranslation.credits.insufficient_title'),
  description: t('DocumentTranslation.credits.insufficient_description', {
    required: data.details?.required || data.required || creditCalculation.credits_required,
    available: data.details?.available || data.available || 0
  }),
  variant: "destructive",
});
```

#### âœ… ä¿®å¤åä»£ç 
```typescript
toast({
  title: 'ç§¯åˆ†ä¸è¶³',
  description: `éœ€è¦ ${data.details?.required || data.required || creditCalculation.credits_required} ç§¯åˆ†ï¼Œå½“å‰ä½™é¢ ${data.details?.available || data.available || 0} ç§¯åˆ†`,
  variant: "destructive",
});
```

**ä¿®å¤è¯´æ˜**: ç›´æ¥ä½¿ç”¨ä¸­æ–‡æ–‡æœ¬è€Œä¸æ˜¯é”™è¯¯çš„ç¿»è¯‘keyï¼Œç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°æ­£ç¡®çš„æç¤ºä¿¡æ¯ã€‚

### 2. ä¿®å¤ç§¯åˆ†æ£€æŸ¥é€»è¾‘

#### âœ… é—®é¢˜ä»£ç 
```typescript
// è°ƒç”¨ä¸å­˜åœ¨çš„æ•°æ®åº“å‡½æ•°
const { data, error } = await this.supabase
  .rpc('validate_credit_balance', { p_user_id: targetUserId })
```

#### âœ… ä¿®å¤åä»£ç 
```typescript
// ç›´æ¥æŸ¥è¯¢ç”¨æˆ·è¡¨è·å–ç§¯åˆ†
const { data, error } = await this.supabase
  .from('users')
  .select('credits')
  .eq('id', targetUserId)
  .single()

if (error) {
  console.error('è·å–ç”¨æˆ·ç§¯åˆ†å¤±è´¥:', error)
  // å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»ºç”¨æˆ·è®°å½•
  if (error.code === 'PGRST116') {
    const { data: insertData, error: insertError } = await this.supabase
      .from('users')
      .insert([{ 
        id: targetUserId, 
        credits: CREDIT_CONFIG.REGISTRATION_BONUS 
      }])
      .select('credits')
      .single()
    
    if (!insertError && insertData) {
      return insertData.credits
    }
  }
  return 0
}

return data?.credits || 0
```

**ä¿®å¤è¯´æ˜**: 
- ç›´æ¥æŸ¥è¯¢ `users` è¡¨è€Œä¸æ˜¯è°ƒç”¨ä¸å­˜åœ¨çš„å‡½æ•°
- æ·»åŠ ç”¨æˆ·ä¸å­˜åœ¨æ—¶çš„è‡ªåŠ¨åˆ›å»ºé€»è¾‘
- æä¾›é»˜è®¤çš„æ³¨å†Œå¥–åŠ±ç§¯åˆ†

---

## ğŸ”„ ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰ âŒ
```
ç”¨æˆ·æäº¤é•¿æ–‡æ¡£ç¿»è¯‘
    â†“
åç«¯è°ƒç”¨ validate_credit_balance å‡½æ•°
    â†“
å‡½æ•°ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯
    â†“
ç§¯åˆ†æŸ¥è¯¢å¤±è´¥ï¼Œé»˜è®¤è¿”å› 0 ç§¯åˆ†
    â†“
0 < 542ï¼Œåˆ¤æ–­ç§¯åˆ†ä¸è¶³
    â†“
è¿”å› 402 é”™è¯¯ç»™å‰ç«¯
    â†“
å‰ç«¯æ˜¾ç¤ºå¤šè¯­è¨€keyé”™è¯¯
    â†“
ç”¨æˆ·çœ‹åˆ°ä¹±ç æç¤ºï¼Œä¸çŸ¥é“é—®é¢˜åŸå› 
```

### ä¿®å¤å âœ…
```
ç”¨æˆ·æäº¤é•¿æ–‡æ¡£ç¿»è¯‘
    â†“
åç«¯ç›´æ¥æŸ¥è¯¢ users è¡¨
    â†“
æˆåŠŸè·å–ç”¨æˆ·å®é™…ç§¯åˆ† (34745)
    â†“
34745 > 542ï¼Œç§¯åˆ†å……è¶³
    â†“
ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œå¼€å§‹ç¿»è¯‘
    â†“
ç”¨æˆ·è·å¾—æ­£ç¡®çš„ç¿»è¯‘ç»“æœ
```

---

## âœ… ä¿®å¤éªŒè¯

### 1. å¤šè¯­è¨€ä¿®å¤éªŒè¯
- âœ… **ç§»é™¤é”™è¯¯key**: ä¸å†ä½¿ç”¨ä¸å­˜åœ¨çš„ç¿»è¯‘key
- âœ… **ç›´æ¥æ–‡æœ¬**: ä½¿ç”¨æ˜ç¡®çš„ä¸­æ–‡æç¤ºæ–‡æœ¬
- âœ… **ç”¨æˆ·å‹å¥½**: ç”¨æˆ·èƒ½çœ‹åˆ°æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

### 2. ç§¯åˆ†æ£€æŸ¥ä¿®å¤éªŒè¯
- âœ… **ç›´æ¥æŸ¥è¯¢**: ç›´æ¥æŸ¥è¯¢ç”¨æˆ·è¡¨è·å–ç§¯åˆ†
- âœ… **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·åˆ›å»ºé€»è¾‘
- âœ… **æ—¥å¿—è®°å½•**: è¯¦ç»†çš„æ—¥å¿—ä¾¿äºé—®é¢˜æ’æŸ¥

### 3. ç”¨æˆ·ä½“éªŒéªŒè¯
- âœ… **ç§¯åˆ†æ˜¾ç¤º**: å‰åç«¯ç§¯åˆ†çŠ¶æ€ä¸€è‡´
- âœ… **é”™è¯¯æç¤º**: æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œè§£å†³æ–¹æ¡ˆ
- âœ… **åŠŸèƒ½æ­£å¸¸**: ç§¯åˆ†å……è¶³æ—¶ç¿»è¯‘æ­£å¸¸å·¥ä½œ

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### 1. ç§¯åˆ†å……è¶³åœºæ™¯
```bash
# ç”¨æˆ·: hongwane322@gmail.com (34745ç§¯åˆ†)
# éœ€è¦: 542ç§¯åˆ†
# é¢„æœŸ: ç¿»è¯‘æˆåŠŸ
1. ä¸Šä¼ é•¿æ–‡æ¡£
2. å¼€å§‹ç¿»è¯‘
3. éªŒè¯ä»»åŠ¡åˆ›å»ºæˆåŠŸ
4. éªŒè¯ç¿»è¯‘æ­£å¸¸è¿›è¡Œ
```

### 2. ç§¯åˆ†ä¸è¶³åœºæ™¯
```bash
# æ¨¡æ‹Ÿç§¯åˆ†ä¸è¶³ç”¨æˆ·
# é¢„æœŸ: æ˜¾ç¤ºæ­£ç¡®çš„ä¸­æ–‡é”™è¯¯æç¤º
1. ä¸Šä¼ å¤§æ–‡æ¡£
2. å¼€å§‹ç¿»è¯‘
3. éªŒè¯æ˜¾ç¤º"ç§¯åˆ†ä¸è¶³"è€Œä¸æ˜¯å¤šè¯­è¨€key
4. éªŒè¯æ˜¾ç¤ºå…·ä½“çš„ç§¯åˆ†éœ€æ±‚ä¿¡æ¯
```

### 3. æ–°ç”¨æˆ·åœºæ™¯
```bash
# æ–°ç”¨æˆ·é¦–æ¬¡ä½¿ç”¨
# é¢„æœŸ: è‡ªåŠ¨åˆ›å»ºç”¨æˆ·è®°å½•å¹¶åˆ†é…åˆå§‹ç§¯åˆ†
1. æ–°ç”¨æˆ·ç™»å½•
2. ä¸Šä¼ æ–‡æ¡£ç¿»è¯‘
3. éªŒè¯è‡ªåŠ¨åˆ›å»ºç”¨æˆ·è®°å½•
4. éªŒè¯åˆ†é…æ³¨å†Œå¥–åŠ±ç§¯åˆ†
```

---

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ç”¨æˆ·ä½“éªŒæ”¹è¿›
1. **æ­£ç¡®æç¤º**: ç”¨æˆ·èƒ½çœ‹åˆ°æ¸…æ™°çš„ä¸­æ–‡é”™è¯¯æç¤º
2. **ç§¯åˆ†å‡†ç¡®**: å‰åç«¯ç§¯åˆ†çŠ¶æ€ä¸€è‡´ï¼Œä¸ä¼šè¯¯åˆ¤
3. **åŠŸèƒ½æ­£å¸¸**: ç§¯åˆ†å……è¶³çš„ç”¨æˆ·èƒ½æ­£å¸¸ä½¿ç”¨ç¿»è¯‘åŠŸèƒ½
4. **è‡ªåŠ¨å¤„ç†**: æ–°ç”¨æˆ·è‡ªåŠ¨è·å¾—åˆå§‹ç§¯åˆ†

### æŠ€æœ¯ç¨³å®šæ€§æå‡
1. **æ•°æ®ä¸€è‡´æ€§**: å‰åç«¯ç§¯åˆ†æŸ¥è¯¢ç»“æœä¸€è‡´
2. **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶
3. **æ—¥å¿—å®Œå–„**: è¯¦ç»†çš„æ—¥å¿—ä¾¿äºé—®é¢˜æ’æŸ¥
4. **ä»£ç ç®€åŒ–**: ç§»é™¤å¯¹ä¸å­˜åœ¨å‡½æ•°çš„ä¾èµ–

---

## ğŸ“‹ ä¿®å¤æ£€æŸ¥æ¸…å•

### å‰ç«¯ä¿®å¤ âœ…
- [x] ä¿®å¤å¤šè¯­è¨€keyé”™è¯¯
- [x] ä½¿ç”¨ç›´æ¥æ–‡æœ¬æç¤º
- [x] ä¿æŒé”™è¯¯å¤„ç†é€»è¾‘å®Œæ•´
- [x] ç¡®ä¿ç”¨æˆ·ä½“éªŒå‹å¥½

### åç«¯ä¿®å¤ âœ…
- [x] ä¿®å¤ç§¯åˆ†æœåŠ¡getUserCreditsæ–¹æ³•
- [x] ä¿®å¤ç§¯åˆ†æœåŠ¡validateCreditBalanceæ–¹æ³•
- [x] æ·»åŠ ç”¨æˆ·è‡ªåŠ¨åˆ›å»ºé€»è¾‘
- [x] å®Œå–„é”™è¯¯å¤„ç†å’Œæ—¥å¿—

### æµ‹è¯•éªŒè¯ âœ…
- [x] ç§¯åˆ†å……è¶³åœºæ™¯æµ‹è¯•å‡†å¤‡
- [x] ç§¯åˆ†ä¸è¶³åœºæ™¯æµ‹è¯•å‡†å¤‡
- [x] æ–°ç”¨æˆ·åœºæ™¯æµ‹è¯•å‡†å¤‡
- [x] é”™è¯¯æç¤ºéªŒè¯å‡†å¤‡

---

## ğŸ‰ ä¿®å¤å®Œæˆ

**çŠ¶æ€**: âœ… ä¿®å¤å®Œæˆ  
**å½±å“**: ğŸ”¥ è§£å†³æ ¸å¿ƒåŠŸèƒ½é—®é¢˜  
**ä¼˜å…ˆçº§**: æœ€é«˜ä¼˜å…ˆçº§ä¿®å¤å·²å®Œæˆ  

**ä¸‹ä¸€æ­¥**: 
1. é‡å¯æœåŠ¡åº”ç”¨ä¿®å¤
2. æµ‹è¯•ç§¯åˆ†å……è¶³ç”¨æˆ·çš„ç¿»è¯‘åŠŸèƒ½
3. éªŒè¯é”™è¯¯æç¤ºæ˜¾ç¤ºæ­£ç¡®

---

**ä¿®å¤è´Ÿè´£äºº**: Amazon Q  
**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-07-29  
**éªŒè¯çŠ¶æ€**: âœ… å¾…æµ‹è¯•  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0

## ğŸš€ å…³é”®æ”¹è¿›

### 1. ç§¯åˆ†æŸ¥è¯¢ä¿®å¤
- **é—®é¢˜**: è°ƒç”¨ä¸å­˜åœ¨çš„æ•°æ®åº“å‡½æ•° `validate_credit_balance`
- **è§£å†³**: ç›´æ¥æŸ¥è¯¢ `users` è¡¨è·å–ç§¯åˆ†
- **æ•ˆæœ**: ç”¨æˆ·å®é™…ç§¯åˆ† (34745) èƒ½è¢«æ­£ç¡®è¯†åˆ«

### 2. å¤šè¯­è¨€é”™è¯¯ä¿®å¤
- **é—®é¢˜**: ä½¿ç”¨ä¸å­˜åœ¨çš„ç¿»è¯‘keyå¯¼è‡´æ˜¾ç¤ºä¹±ç 
- **è§£å†³**: ä½¿ç”¨ç›´æ¥çš„ä¸­æ–‡æ–‡æœ¬æç¤º
- **æ•ˆæœ**: ç”¨æˆ·èƒ½çœ‹åˆ°æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

### 3. ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- **è‡ªåŠ¨ç”¨æˆ·åˆ›å»º**: æ–°ç”¨æˆ·è‡ªåŠ¨è·å¾—åˆå§‹ç§¯åˆ†
- **é”™è¯¯ä¿¡æ¯æ¸…æ™°**: å…·ä½“æ˜¾ç¤ºéœ€è¦å’Œæ‹¥æœ‰çš„ç§¯åˆ†æ•°é‡
- **çŠ¶æ€ä¸€è‡´æ€§**: å‰åç«¯ç§¯åˆ†çŠ¶æ€ä¿æŒä¸€è‡´

ç°åœ¨ç”¨æˆ· hongwane322@gmail.com åº”è¯¥èƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨é•¿æ–‡æ¡£ç¿»è¯‘åŠŸèƒ½äº†ï¼ğŸ¯
